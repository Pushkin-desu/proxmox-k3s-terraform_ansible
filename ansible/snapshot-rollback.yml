- name: Rollback VMs to snapshot via API
  hosts: localhost
  gather_facts: false
  vars:
    request_timeout: 180
  tasks:
    - name: Validate required environment vars
      fail:
        msg: "Нужно: PROXMOX_API_HOST / PROXMOX_API_TOKEN_ID / PROXMOX_API_TOKEN_SECRET экспортированы и -e snapshot_name=..."
      when:
        - (lookup('env','PROXMOX_API_TOKEN_ID') | length) == 0
        - (lookup('env','PROXMOX_API_TOKEN_SECRET') | length) == 0
        - snapshot_name is not defined

    - name: Build list of target IPs
      set_fact:
        all_vm_ips: "{{ (groups['k3s_masters'] | default([])) + (groups['k3s_workers'] | default([])) }}"

    - name: Fail if empty inventory groups
      fail:
        msg: "Нет хостов в группах k3s_masters / k3s_workers. Убедись что -i ansible/hosts указан."
      when: all_vm_ips | length == 0

    - name: Initialize vm_list
      set_fact:
        vm_list: []

    - name: Accumulate vm_list from host_vars
      set_fact:
        vm_list: "{{ vm_list + [ {
          'name':   hostvars[item].name | default(item),
          'ip':     item,
          'vmid':   hostvars[item].vmid | default(None),
          'node':   hostvars[item].proxmox_node | default(None)
        } ] }}"
      loop: "{{ all_vm_ips }}"

    - name: Validate vm metadata
      fail:
        msg: "Для одного или более хостов нет vmid или proxmox_node в host_vars. Проверь ansible/host_vars/<IP>.yml."
      when: vm_list | selectattr('vmid','equalto', None) | list | length > 0
            or vm_list | selectattr('node','equalto', None) | list | length > 0
    - name: Set base URL fact
      set_fact:
        proxmox_api_base_url: "https://{{ lookup('env','PROXMOX_API_HOST') }}:8006/api2/json"
        
    - name: Rollback each VM
      loop: "{{ vm_list }}"
      loop_control:
        label: "{{ item.name }}"
      uri:
        url: "{{ proxmox_api_base_url }}/nodes/{{ item.node }}/qemu/{{ item.vmid }}/snapshot/{{ snapshot_name }}/rollback"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ lookup('env','PROXMOX_API_TOKEN_ID') }}={{ lookup('env','PROXMOX_API_TOKEN_SECRET') }}"
        validate_certs: false
        status_code: 200
        return_content: true
        timeout: 300
      register: rollback_responses

    - name: Show rollback results
      debug:
        var: rollback_responses

    - name: Start all VMs after rollback
      loop: "{{ vm_list }}"
      loop_control:
        label: "{{ item.name }}"
      uri:
        url: "{{ proxmox_api_base_url }}/nodes/{{ item.node }}/qemu/{{ item.vmid }}/status/start"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ lookup('env','PROXMOX_API_TOKEN_ID') }}={{ lookup('env','PROXMOX_API_TOKEN_SECRET') }}"
        validate_certs: false
        status_code: 200
        return_content: true
        timeout: 120
      register: start_results

    - name: Show start results
      debug:
        var: start_results