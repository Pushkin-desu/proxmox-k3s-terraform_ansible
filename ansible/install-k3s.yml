- name: Prepare all nodes (masters + workers)
  hosts: k3s_masters:k3s_workers
  become: true
  gather_facts: true
  tasks:
    - name: Install base packages
      apt:
        name:
          - curl
          - ca-certificates
          - gnupg
          - lsb-release
          - net-tools
        state: present
        update_cache: yes

    - name: Disable swap runtime
      command: swapoff -a
      when: ansible_swaptotal_mb|int > 0

    - name: Comment swap in fstab
      replace:
        path: /etc/fstab
        regexp: '^(.*\sswap\s.*)$'
        replace: '# \1'

    - name: Load kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: Persist modules on reboot
      copy:
        dest: /etc/modules-load.d/k8s.conf
        mode: '0644'
        content: |
          overlay
          br_netfilter

    - name: Sysctl params for k8s
      copy:
        dest: /etc/sysctl.d/99-k8s.conf
        mode: '0644'
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1

    - name: Apply sysctl
      command: sysctl --system

- name: Initialize first k3s master
  hosts: "{{ groups['k3s_masters'][0] }}"
  become: true
  vars:
    k3s_bin_path: /usr/local/bin/k3s
  tasks:
    - name: Download k3s binary
      get_url:
        url: "https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s"
        dest: "{{ k3s_bin_path }}"
        mode: '0755'

    - name: Check etcd member dir (cluster initialized?)
      stat:
        path: /var/lib/rancher/k3s/server/db/etcd/member
      register: etcd_member_dir

    - name: Set cluster_init fact (true если нет etcd данных)
      set_fact:
        cluster_init: "{{ not etcd_member_dir.stat.exists }}"

    - name: Debug init mode
      debug:
        msg: "cluster_init={{ cluster_init }} (etcd_member_dir.exists={{ etcd_member_dir.stat.exists }})"

    - name: Render k3s server unit (first master)
      template:
        src: templates/k3s.service.j2
        dest: /etc/systemd/system/k3s.service
        mode: '0644'
      vars:
        join_server: ""
        join_token: ""

    - name: systemd reload
      systemd:
        daemon_reload: true

    - block:
        - name: Ensure k3s server running
          systemd:
            name: k3s
            state: started
            enabled: true

        - name: Wait for node-token file
          wait_for:
            path: /var/lib/rancher/k3s/server/node-token
            timeout: 300

        - name: Wait for API port
          wait_for:
            host: "{{ k3s_master_ip }}"
            port: 6443
            timeout: 300

      rescue:
        - name: Collect k3s journal
          command: journalctl -u k3s -n 200 --no-pager
          register: k3s_journal
          ignore_errors: true
        - name: Show journal
          debug:
            msg: "{{ k3s_journal.stdout | default('no journal') }}"
        - name: Fail early
          fail:
            msg: "k3s failed to start on first master"

    - name: Read node-token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: ntok
      changed_when: false

    - name: Set cluster_node_token fact
      set_fact:
        cluster_node_token: "{{ ntok.content | b64decode | trim }}"

    - name: Read kubeconfig
      slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kube_cfg
      changed_when: false

    - name: Adjust kubeconfig server IP
      set_fact:
        kubeconfig_content: "{{ (kube_cfg.content | b64decode) | replace('127.0.0.1', k3s_master_ip) }}"

    - name: Save kubeconfig locally
      copy:
        content: "{{ kubeconfig_content }}"
        dest: "../kubeconfig-master.yaml"
        mode: '0644'
      delegate_to: localhost
      become: false

- name: Join other k3s masters
  hosts: "{{ groups['k3s_masters'][1:] }}"
  become: true
  vars:
    k3s_bin_path: /usr/local/bin/k3s
    first_master: "{{ groups['k3s_masters'][0] }}"
  tasks:
    - name: Assert token available
      assert:
        that:
          - hostvars[first_master].cluster_node_token is defined
        fail_msg: "Cluster token not found on first master."

    - name: Download k3s binary
      get_url:
        url: "https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s"
        dest: "{{ k3s_bin_path }}"
        mode: '0755'

    - name: Render k3s server unit (joining master)
      template:
        src: templates/k3s.service.j2
        dest: /etc/systemd/system/k3s.service
        mode: '0644'
      vars:
        cluster_init: false
        join_server: "https://{{ hostvars[first_master].k3s_master_ip }}:6443"
        join_token: "{{ hostvars[first_master].cluster_node_token }}"

    - name: systemd reload
      systemd:
        daemon_reload: true

    - name: Ensure k3s server running (joined master)
      systemd:
        name: k3s
        state: started
        enabled: true

- name: Install / start k3s agents (workers)
  hosts: k3s_workers
  become: true
  vars:
    k3s_bin_path: /usr/local/bin/k3s
    first_master: "{{ groups['k3s_masters'][0] }}"
  tasks:
    - name: Assert token available
      assert:
        that:
          - hostvars[first_master].cluster_node_token is defined
        fail_msg: "Cluster token not found on first master."

    - name: Download k3s binary
      get_url:
        url: "https://github.com/k3s-io/k3s/releases/download/{{ k3s_version }}/k3s"
        dest: "{{ k3s_bin_path }}"
        mode: '0755'

    - name: Render k3s agent unit
      template:
        src: templates/k3s-agent.service.j2
        dest: /etc/systemd/system/k3s-agent.service
        mode: '0644'
      vars:
        k3s_url: "https://{{ hostvars[first_master].k3s_master_ip }}:6443"
        k3s_token: "{{ hostvars[first_master].cluster_node_token }}"

    - name: systemd reload
      systemd:
        daemon_reload: true

    - name: Ensure k3s agent running
      systemd:
        name: k3s-agent
        state: started
        enabled: true

- name: Build list of worker node hostnames
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Collect worker node hostnames from host_vars
      set_fact:
        worker_node_names: "{{ worker_node_names | default([]) + [hostvars[item].name | default(item)] }}"
      loop: "{{ groups['k3s_workers'] }}"

    - name: Wait for all worker nodes to appear in Kubernetes
      shell: |
        kubectl --kubeconfig ../kubeconfig-master.yaml get nodes {{ item }}
      register: node_check
      retries: 30
      delay: 5
      until: node_check.rc == 0
      loop: "{{ worker_node_names }}"
      ignore_errors: false

    - name: Label all worker nodes in Kubernetes
      shell: |
        kubectl --kubeconfig ../kubeconfig-master.yaml label node {{ item }} node-role.kubernetes.io/worker=true --overwrite
      loop: "{{ worker_node_names }}"