- name: Migrate VM disks to local storage (run on localhost, but inventory must be loaded)
  hosts: localhost
  gather_facts: false
  vars:
    request_timeout: 180
  tasks:
    - name: Validate required environment vars
      fail:
        msg: "Нужно: PROXMOX_API_HOST / PROXMOX_API_TOKEN_ID / PROXMOX_API_TOKEN_SECRET экспортированы в окружение."
      when:
        - (lookup('env','PROXMOX_API_TOKEN_ID') | length) == 0
        - (lookup('env','PROXMOX_API_TOKEN_SECRET') | length) == 0
        - (lookup('env','PROXMOX_API_HOST') | length) == 0

    - name: Build list of target IPs
      set_fact:
        all_vm_ips: "{{ (groups['storage_migration'] | default([])) }}"

    - name: Fail if empty inventory groups
      fail:
        msg: "Нет хостов в группе storage_migration. Убедись что -i ansible/hosts указан."
      when: all_vm_ips | length == 0

    - name: Initialize vm_list
      set_fact:
        vm_list: []

    - name: Accumulate vm_list from host_vars
      set_fact:
        vm_list: "{{ vm_list + [ {
          'name':   hostvars[item].name | default(item),
          'ip':     item,
          'vmid':   hostvars[item].vmid | default(None),
          'node':   hostvars[item].proxmox_node | default(None),
          'target_store': hostvars[item].storage_target | default(None)
        } ] }}"
      loop: "{{ all_vm_ips }}"

    - name: Validate vm metadata
      fail:
        msg: "Для одного или более хостов нет vmid или proxmox_node в host_vars. Проверь ansible/host_vars/<IP>.yml."
      when: vm_list | selectattr('vmid','equalto', None) | list | length > 0
            or vm_list | selectattr('node','equalto', None) | list | length > 0

    - name: Show built vm_list
      debug:
        var: vm_list

    - name: Set base URL fact
      set_fact:
        proxmox_api_base_url: "https://{{ lookup('env','PROXMOX_API_HOST') }}:8006/api2/json"

    - name: Get VM disk information
      loop: "{{ vm_list }}"
      loop_control:
        label: "{{ item.name }}"
      uri:
        url: "{{ proxmox_api_base_url }}/nodes/{{ item.node }}/qemu/{{ item.vmid }}/config"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ lookup('env','PROXMOX_API_TOKEN_ID') }}={{ lookup('env','PROXMOX_API_TOKEN_SECRET') }}"
        validate_certs: false
        return_content: true
        status_code: 200
        timeout: "{{ request_timeout }}"
      register: vm_configs

    - name: Process each VM and build disk migration list
      set_fact:
        vm_list_with_disks: "{{ vm_list_with_disks_json | from_json }}"
      vars:
        vm_list_with_disks_json: >-
          {%- set result = [] -%}
          {%- for vm in vm_list -%}
            {%- set config_index = loop.index0 -%}
            {%- set config_data = vm_configs.results[config_index].json.data -%}
            {%- set disks = [] -%}
            
            {%- for key, value in config_data.items() -%}
              {%- if (key.startswith('scsi') or key.startswith('virtio') or key.startswith('sata') and ':' in key) and not key.startswith('scsihw') -%}
                {%- set disk_name = key.split(':')[0] -%}
                {%- set storage_parts = value.split(',') -%}
                {%- set storage_part = storage_parts | select('match', '^[a-zA-Z]') | first | default('unknown') -%}
                {%- set current_storage_full = storage_part.split('=')[1] if '=' in storage_part else storage_part -%}
                {%- set current_storage = current_storage_full.split(':')[0] -%}
                {%- set needs_migration = current_storage != vm.target_store -%}
                {%- set _ = disks.append({
                  'name': disk_name,
                  'current_storage': current_storage_full,
                  'current_storage_short': current_storage,
                  'needs_migration': needs_migration
                }) -%}
              {%- endif -%}
            {%- endfor -%}

            {%- set needs_any_migration = (disks | selectattr('needs_migration') | list | length > 0) -%}
            
            {%- set _ = result.append({
              'name': vm.name,
              'ip': vm.ip,
              'vmid': vm.vmid,
              'node': vm.node,
              'target_store': vm.target_store,
              'disks': disks,
              'needs_any_migration': needs_any_migration
            }) -%}

          

          {%- endfor -%}
          {{ result | to_json }}

    - name: Show disk analysis
      debug:
        msg: |
          {{ item.name }} (vmid {{ item.vmid }}):
          {% for disk in item.disks %}
            - {{ disk.name }}: {{ disk.current_storage }} -> {{ item.target_store }} {% if disk.needs_migration %}(NEEDS MIGRATION){% else %}(ALREADY ON TARGET){% endif %}
          {% endfor %}
          Needs any migration: {{ item.needs_any_migration }}
      loop: "{{ vm_list_with_disks }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Skip VMs that don't need migration
      debug:
        msg: "Пропускаем {{ item.name }} - все диски уже в целевом хранилище"
      loop: "{{ vm_list_with_disks }}"
      loop_control:
        label: "{{ item.name }}"
      when: not item.needs_any_migration

    - name: Filter VMs that need migration
      set_fact:
        vms_needing_migration: "{{ vm_list_with_disks | selectattr('needs_any_migration') | list }}"

    - name: Check if any VMs need migration
      fail:
        msg: "Нет ВМ требующих миграции дисков. Все диски уже в целевых хранилищах."
      when: vms_needing_migration | length == 0

    - name: Stop VMs for migration
      loop: "{{ vms_needing_migration }}"
      loop_control:
        label: "{{ item.name }}"
      uri:
        url: "{{ proxmox_api_base_url }}/nodes/{{ item.node }}/qemu/{{ item.vmid }}/status/stop"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ lookup('env','PROXMOX_API_TOKEN_ID') }}={{ lookup('env','PROXMOX_API_TOKEN_SECRET') }}"
        validate_certs: false
        status_code: 200
        return_content: true
        timeout: "{{ request_timeout }}"
      register: stop_results
      retries: 5
      delay: 10
      until: stop_results is success

    - name: Wait for VMs to stop
      loop: "{{ vms_needing_migration }}"
      loop_control:
        label: "{{ item.name }}"
      uri:
        url: "{{ proxmox_api_base_url }}/nodes/{{ item.node }}/qemu/{{ item.vmid }}/status/current"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ lookup('env','PROXMOX_API_TOKEN_ID') }}={{ lookup('env','PROXMOX_API_TOKEN_SECRET') }}"
        validate_certs: false
        return_content: true
        status_code: 200
        timeout: "{{ request_timeout }}"
      register: status_check
      until: status_check.json.data.status == 'stopped'
      retries: 30
      delay: 5

    - name: Migrate only disks that need migration
      loop: "{{ vms_needing_migration | subelements('disks', skip_missing=true) }}"
      loop_control:
        label: "{{ item.0.name }} - {{ item.1.name }}"
      when: item.1.needs_migration
      vars:
        current_vm: "{{ item.0 }}"
        disk_info: "{{ item.1 }}"
      uri:
        url: "{{ proxmox_api_base_url }}/nodes/{{ current_vm.node }}/qemu/{{ current_vm.vmid }}/move_disk"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ lookup('env','PROXMOX_API_TOKEN_ID') }}={{ lookup('env','PROXMOX_API_TOKEN_SECRET') }}"
        body_format: form-urlencoded
        body:
          disk: "{{ disk_info.name }}"
          storage: "{{ current_vm.target_store }}"
          delete: "1"
        validate_certs: false
        status_code: 200
        return_content: true
        timeout: "{{ request_timeout }}"
      register: migrate_results
      retries: 10
      delay: 10
      until: migrate_results is success

    - name: Wait for all disk migrations to complete
      loop: "{{ vms_needing_migration }}"
      loop_control:
        label: "{{ item.name }}"
      uri:
        url: "{{ proxmox_api_base_url }}/nodes/{{ item.node }}/qemu/{{ item.vmid }}/status/current"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ lookup('env','PROXMOX_API_TOKEN_ID') }}={{ lookup('env','PROXMOX_API_TOKEN_SECRET') }}"
        validate_certs: false
        return_content: true
        status_code: 200
        timeout: "{{ request_timeout }}"
      register: migration_status_check
      until: 
        - migration_status_check is success
        - migration_status_check.json.data.lock is not defined
      retries: 60
      delay: 10

    - name: Start VMs after migration
      loop: "{{ vms_needing_migration }}"
      loop_control:
        label: "{{ item.name }}"
      uri:
        url: "{{ proxmox_api_base_url }}/nodes/{{ item.node }}/qemu/{{ item.vmid }}/status/start"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ lookup('env','PROXMOX_API_TOKEN_ID') }}={{ lookup('env','PROXMOX_API_TOKEN_SECRET') }}"
        validate_certs: false
        status_code: 200
        return_content: true
        timeout: "{{ request_timeout }}"
      register: start_results
      retries: 5
      delay: 10
      until: start_results is success

    - name: Wait for VMs to start
      loop: "{{ vms_needing_migration }}"
      loop_control:
        label: "{{ item.name }}"
      uri:
        url: "{{ proxmox_api_base_url }}/nodes/{{ item.node }}/qemu/{{ item.vmid }}/status/current"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ lookup('env','PROXMOX_API_TOKEN_ID') }}={{ lookup('env','PROXMOX_API_TOKEN_SECRET') }}"
        validate_certs: false
        return_content: true
        status_code: 200
        timeout: "{{ request_timeout }}"
      register: start_status_check
      until: start_status_check.json.data.status == 'running'
      retries: 30
      delay: 5

    - name: Report migration results
      debug:
        msg: |
          Результаты миграции:
          
          Успешно мигрированы:
          {% for vm in vms_needing_migration %}
          - {{ vm.name }} (vmid {{ vm.vmid }}):
            {% for disk in vm.disks %}
              {% if disk.needs_migration %}  * {{ disk.name }}: {{ disk.current_storage }} -> {{ vm.target_store }}{% endif %}
            {% endfor %}
          {% endfor %}
          
          Уже в целевом хранилище:
          {% for vm in vm_list_with_disks %}
            {% if not vm.needs_any_migration %}
          - {{ vm.name }} (vmid {{ vm.vmid }})
            {% endif %}
          {% endfor %}